<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>批发市场采购分析仪表板</title>
    <link rel="icon" href="../../shared/assets/logo/logo.png" />
    <link rel="stylesheet" href="./styles.css" />
    <script src="../../shared/vendor/vue.global.js"></script>
    <script src="../../shared/vendor/echarts.min.js"></script>
  </head>
  <body data-pattern="on">
    <div id="app">
      <header class="header">
        <h1>批发市场子系统—白条猪</h1>
        <div class="nav-filters">
          <div class="filter-group">
            <span class="filter-label">市场</span>
            <select class="nav-select-header" v-model="market" @change="handleMarketChange">
              <option v-for="m in markets" :key="m.value" :value="m.value">{{ m.label }}</option>
            </select>
          </div>
          
          <div class="filter-group">
            <span class="filter-label">日期</span>
            <div class="nav-datepicker-header readonly-date">{{ date }}</div>
          </div>
        </div>
        <nav class="nav-tabs" aria-label="顶部导航">
          <a :href="'../screen/index.html?marketId=' + market" class="nav-tab nav-tab-primary">实时交易</a>
          <a :href="'../history/index.html?marketId=' + market" class="nav-tab">历史查询</a>
          <a href="#" class="nav-tab active">数据分析</a>
        </nav>
      </header>

      <div class="container">
        <aside class="sidebar" aria-label="左侧菜单">
          <div class="menu-item" :class="{active: activeMenu==='volume'}" @click="selectMenu('volume')">交易量走势</div>
          <div class="menu-item" :class="{active: activeMenu==='amount'}" @click="selectMenu('amount')">交易额走势</div>
          <div class="menu-item" :class="{active: activeMenu==='avgprice'}" @click="selectMenu('avgprice')">交易均价走势</div>
          <div class="menu-item" :class="{active: activeMenu==='commission'}" @click="selectMenu('commission')">交易佣金费率与交易佣金费走势</div>
          <div class="menu-item" :class="{active: activeMenu==='province16'}" @click="selectMenu('province16')">16省平均出厂价与市场交易均价走势</div>
          <div class="menu-item" :class="{active: activeMenu==='reports'}" @click="selectMenu('reports')">分析报告</div>
        </aside>

        <main class="content">
          <div class="chart-card" v-if="activeMenu==='volume'">
            <h3 class="chart-title">交易量趋势图（近30天）</h3>
            <div id="trendChart"></div>
          </div>
          <div class="chart-card" v-if="activeMenu==='volume'">
            <h3 class="chart-title">解读</h3>
            <div class="insights">暂无解读</div>
          </div>

          <div class="chart-card" v-if="activeMenu==='amount'">
            <h3 class="chart-title">交易额趋势图（近30天）</h3>
            <div id="amountChart"></div>
          </div>
          <div class="chart-card" v-if="activeMenu==='amount'">
            <h3 class="chart-title">解读</h3>
            <div class="insights">暂无解读</div>
          </div>

          <div class="chart-card" v-if="activeMenu==='avgprice'">
            <h3 class="chart-title">交易均价趋势图（近30天）</h3>
            <div class="chart-toolbar">
              <div></div>
              <div class="chart-legend">
                <div class="legend-item"><span class="legend-icon avgprice-solid"></span>交易均价</div>
                <div class="legend-item"><span class="legend-icon avgprice-dashed"></span>交易均价（不含异常交易）</div>
              </div>
            </div>
            <div id="avgPriceChart"></div>
          </div>
          <div class="chart-card" v-if="activeMenu==='avgprice'">
            <h3 class="chart-title">解读</h3>
            <div class="insights">暂无解读</div>
          </div>

          <div class="chart-card" v-if="activeMenu==='commission'">
            <h3 class="chart-title">交易佣金费率与交易佣金费走势图（近30天）</h3>
            <div class="chart-toolbar">
              <div></div>
              <div class="chart-legend">
                <div class="legend-item"><span class="legend-icon rate"></span>交易佣金费率</div>
                <div class="legend-item"><span class="legend-icon fee"></span>交易佣金费</div>
              </div>
            </div>
            <div id="commissionChart"></div>
          </div>
          <div class="chart-card" v-if="activeMenu==='commission'">
            <h3 class="chart-title">解读</h3>
            <div class="insights">暂无解读</div>
          </div>

          <div class="chart-card" v-if="activeMenu==='province16'">
            <h3 class="chart-title">16省平均出厂价与市场交易均价走势图（近30天）</h3>
            <div class="chart-toolbar">
              <div class="filter-group">
                <span class="filter-label">省份</span>
                <select class="nav-select-header" v-model="province16" @change="handleProvince16Change">
                  <option v-for="p in provinces" :key="p.value" :value="p.value">{{ p.label }}</option>
                </select>
              </div>
              <div class="chart-legend">
                <div class="legend-item"><span class="legend-icon factory"></span>该省平均出厂价</div>
                <div class="legend-item"><span class="legend-icon market"></span>市场交易均价（不含异常交易）</div>
              </div>
            </div>
            <div id="provinceChart"></div>
          </div>
          <div class="chart-card" v-if="activeMenu==='province16'">
            <h3 class="chart-title">解读</h3>
            <div class="insights">暂无解读</div>
          </div>

          <div class="chart-card" v-if="activeMenu==='reports'">
            <h3 class="chart-title">分析报告</h3>
            <div class="report-type-bar">
              <div class="report-type-buttons">
                <button class="report-type-btn" v-for="t in reportTypes" :key="t.value" :class="{active: reportTypeValue===t.value}" @click="setReportType(t.value)">{{ t.label }}</button>
              </div>
              <div class="report-search">
                <input class="report-input" v-model="reportKeyword" placeholder="请输入关键词" @keyup.enter="searchReports" />
                <button class="btn" @click="searchReports">查询</button>
              </div>
            </div>
            <div class="reports-grid">
              <div class="report-card" :class="{placeholder: r.placeholder}" v-for="r in pageReports" :key="r.id">
                <template v-if="!r.placeholder">
                  <div class="report-header">
                    <div class="report-name">{{ r.name }}</div>
                    <div class="report-time">{{ r.uploadedAt }}</div>
                  </div>
                  <div class="report-summary">{{ r.summary }}</div>
                  <div class="report-actions">
                    <button class="btn" @click="preview(r)">预览</button>
                    <button class="btn outline" @click="download(r)">下载</button>
                  </div>
                </template>
                <div class="placeholder-body" v-else>
                 
                  <div class="placeholder-note">暂无报告</div>
                </div>
              </div>
            </div>
            <div class="reports-controls">
              <div class="page-info">第 {{ currentPage }} / {{ totalPages }} 页 · 每页 {{ pageSize }} 条</div>
              <div class="pager">
                <button class="pager-btn" @click="prevPage" :disabled="currentPage===1">上一页</button>
                <button class="pager-btn" @click="nextPage" :disabled="currentPage===totalPages">下一页</button>
              </div>
            </div>
          </div>
        </main>
      </div>
      
      <div class="modal-mask" v-show="showPreview" @click.self="closePreview">
        <div class="modal">
          <div class="modal-header">
            <div class="modal-title">{{ previewReport && previewReport.name }}</div>
            <button class="modal-close" @click="closePreview">×</button>
          </div>
          <div class="modal-body">
            <div class="modal-meta">上传时间：{{ previewReport && previewReport.uploadedAt }}</div>
            <div class="modal-summary">{{ previewReport && previewReport.summary }}</div>
            <div v-if="previewReport && previewReport.fileUrl" class="modal-pdf-actions">
              <div class="modal-pdf-name">{{ previewReport.fileName }}</div>
              <button class="btn" @click="download(previewReport)">打开 PDF 文件</button>
            </div>
            <div v-else class="modal-placeholder">暂无文件，已展示摘要内容。</div>
          </div>
        </div>
      </div>
    </div>

    <script src="../../shared/api/config.js"></script>
    <script src="../../shared/api/modules/analysis.js"></script>
    <script src="./app.js"></script>
  </body>
</html>
