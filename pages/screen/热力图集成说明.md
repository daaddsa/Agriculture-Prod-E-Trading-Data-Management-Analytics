# 热力图（热力地图 含省市）集成到大屏说明

将 `map` 项目中的「热力地图 含省市」组件集成到 `pages/screen` 大屏页面，替换原来的地图图片（`/shared/image/map.png`）。

## 一、集成方式概览

- **大屏与 map 使用同一套 DataV 大屏框架**（同一套 `app.1d54c196.js`、`chunk-vendors` 等），已支持 ECharts 热力图组件（`EChartMap` / `eHotMap`）。
- **集成 = 在大屏配置里用「热力图组件」替换「地图图片」组件**，保持原地图区域的位置和尺寸。

## 二、推荐步骤（使用脚本一键集成）

### 1. 准备可读配置（若尚未生成）

```bash
# 在项目根目录执行
node pages/screen/js/tools/format-config.js map/js
node pages/screen/js/tools/format-config.js
```

- 第一条：生成 `map/js/app.data.readable.js`
- 第二条：生成 `pages/screen/js/app.data.readable.js`

### 2. 执行热力图集成脚本

```bash
# 在项目根目录执行
node pages/screen/js/tools/merge-heatmap-to-screen.js
```

脚本会：

- 从 `map/js/app.data.readable.js` 读取「热力地图 含省市」组件配置
- 在 `pages/screen/js/app.data.readable.js` 中用该热力图**替换**「地图图片」组件
- 保持原地图区域：位置 `x=317, y=-8`，尺寸 `1252×930`，`zindex=14`

### 3. 生成压缩配置并刷新页面

```bash
node pages/screen/js/tools/build-config.js
```

会生成/覆盖 `pages/screen/js/app.data.js`。刷新大屏页面即可看到热力图。

---

## 三、手动集成（可选）

若不想用脚本，可手动操作：

1. 打开 `map/js/app.data.readable.js`，找到配置项 `"cpmqAvPb19UjEb8VpWD2diEJ"`（热力地图 含省市），复制整个对象（从 `"cpmqAvPb19UjEb8VpWD2diEJ": {` 到对应的 `},` 结束）。
2. 打开 `pages/screen/js/app.data.readable.js`，找到 `"cpmbd3a7549-e208-42e1-a158-fa080262956e"`（地图图片），用上一步复制的对象**整体替换**该对象。
3. 在替换后的对象中修改以下字段，使其与原地图区域一致：
   - 将 key 和 `_key` 改为：`cpmbd3a7549-e208-42e1-a158-fa080262956e`
   - `"x": 1048` → `"x": 317`
   - `"y": 42` → `"y": -8`
   - `"width": 832` → `"width": 1252`
   - `"height": 953` → `"height": 930`
   - `"zindex": 6` → `"zindex": 14`
   - `"id": 1743471423202` → `"id": 1770110536420`
4. 保存后执行：`node pages/screen/js/tools/build-config.js`，再刷新大屏。

---

## 四、数据与联动说明

- 热力图数据在组件配置的 `data.value` / `data.default` 中（各省名称 + 数值）。
- 若大屏使用 `custom.data.js` 等通过 `window._DS_DATA.dataSet` 更新数据，可在编辑器中为该热力图组件设置**数据集名称**（如 `"项目分布"`），则 `_DS_DATA.dataSet["项目分布"]` 更新时会自动刷新热力图。
- 地图依赖的 GeoJSON：大屏目录下已有 `pages/screen/js/china.json`。**热力图组件从 `window.DS_GEO[adcode]` 读取地图数据**（adcode 为 "100000" 表示全国），因此页面必须在应用脚本之前把 china.json 写入 `window.DS_GEO["100000"]`。已在 `pages/screen/index.html` 中加入预加载脚本：先 fetch `./js/china.json` 并设置 `window.DS_GEO["100000"]`，再加载 chunk-vendors 和 app，否则地图不会注册、热力图不显示。

---

## 五、若集成后热力图不显示

可检查：

1. 是否已执行 `build-config.js` 并刷新页面（强刷：Ctrl+F5）。
2. 浏览器控制台是否有报错（如 ECharts、china.json 加载失败）。
3. `pages/screen/js/app.data.js` 中是否已包含 `render: "EChartMap"`、`contentType: "eHotMap"` 的组件（说明替换已生效）。
4. **数据名称必须与 china.json 一致**：ECharts 按「区域名称」匹配数据。`pages/screen/js/china.json` 里省份是简写（如「北京」「河北」「广西」），热力图里的 `data.value` / `data.default` 也必须用相同写法，不能用「北京市」「河北省」「广西壮族自治区」等全称，否则地图会空白或不上色。已在大屏可读配置中统一改为简写。
5. **图层顺序**：热力图组件的 `zindex` 建议与原先地图图片一致（如 14），否则可能被其他组件挡住。
6. **必须预置 window.DS_GEO**：框架地图组件通过 `getGeoData()` 调用 `this.$echarts.registerMap(adcode, window.DS_GEO[adcode])`，若未事先设置 `window.DS_GEO["100000"]`（中国地图 GeoJSON），热力图不会显示。index.html 中已加入在应用启动前加载 `./js/china.json` 并写入 `window.DS_GEO["100000"]` 的脚本。

---

## 六、调整省份颜色与鼠标悬停

### 1. 鼠标悬停高亮与显示内容（已开启）

已在热力图配置中开启：

- **geo.silent: false**：允许地图响应鼠标事件。
- **geo.itemStyle.emphasis**：悬停时省份高亮（更亮的边框、半透明填充）。
- **geo.label.emphasis.show: true**：悬停时显示省份名称。
- **series[0].emphasis**：地图系列悬停样式。
- **tooltip**：悬停时显示提示框，内容为「省份名 + 数值」（`formatter: "{b}<br/>{c}"`）。

刷新大屏后，鼠标移到任意省份上即可高亮并看到名称和数值。提示框样式（背景色、边框、字号等）会受组件 `config` 中 `tooltipBackgroundColor`、`tooltipTextColor` 等影响。

### 2. 整体配色（按数值渐变）

热力图的默认颜色由 **config.valueColors** 控制（低→高渐变），例如：

- 在 `app.data.readable.js` 中搜索热力图组件的 **"valueColors"**，当前类似：
  - `["#e0ffff", "#006edd"]`（浅青→深蓝）
- 可改成任意两个颜色，如：`["#fff7bc", "#d73027"]`（浅黄→红），保存后刷新即可。

### 3. 为某个省份单独设颜色

若需要某几个省份固定为指定颜色（不按数值渐变），可在 **data.default**（以及需要一致的 **data.value**）里，给对应省份增加 **itemStyle.color**：

在 `app.data.readable.js` 中，找到热力图组件的 `"data"` → `"default"` 数组，把普通项：

```json
{ "name": "广东", "value": 998 }
```

改成：

```json
{ "name": "广东", "value": 998, "itemStyle": { "color": "#1a7fb8" } }
```

`#1a7fb8` 换成你需要的十六进制颜色即可。只加了 `itemStyle` 的省份会使用该颜色，其余省份仍按 valueColors 渐变。修改后保存、刷新大屏即可生效。
